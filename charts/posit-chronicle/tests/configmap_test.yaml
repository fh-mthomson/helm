suite: Configmap tests
templates:
  - templates/configmap.yaml
tests:
  - it: should always create a config map
    asserts:
    - hasDocuments:
        count: 1
    - isKind:
        of: ConfigMap
  - it: should use http by default
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[HTTP\]
          Listen = :5252
  - it: should properly configure https when enabled
    set:
      server:
        https:
          enabled: true
          certificate: /etc/ssl/ssl.crt
          key: /etc/ssl/ssl.key
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[HTTPS\]
          Listen = :443
          Certificate = \/etc\/ssl\/ssl.crt
          Key = \/etc\/ssl\/ssl.key
  - it: should set a default logging configuration
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[Logging\]
          ServiceLog = STDOUT
          ServiceLogLevel = INFO
          ServiceLogFormat = TEXT
  - it: should set values for a custom logging configuration
    set:
        server:
          logging:
            serviceLog: STDERR
            serviceLogLevel: DEBUG
            serviceLogFormat: JSON
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[Logging\]
          ServiceLog = STDERR
          ServiceLogLevel = DEBUG
          ServiceLogFormat = JSON
  - it: should disable metrics by default
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[Metrics\]
          Enabled = false
  - it: should enable metrics when specified
    set:
      server:
        metrics:
          enabled: true
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[Metrics\]
          Enabled = true
  - it: should disable profiling by default
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[Profiling\]
          Enabled = false
  - it: should enable profiling when specified
    set:
      server:
        profiling:
          enabled: true
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[Profiling\]
          Enabled = true
          Listen = :3030
  - it: should set the profiling listening port when specified
    set:
      server:
        profiling:
          enabled: true
          port: 3131
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[Profiling\]
          Enabled = true
          Listen = :3131
  - it: should enable and configure local storage by default
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[LocalStorage\]
          Enabled = true
          Location = \/opt\/chronicle-data
          RetentionPeriod = 30d
  - it: should set values for a custom local storage configuration
    set:
      server:
        storage:
          local:
            path: /custom/data/path
            retentionPeriod: 60d
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[LocalStorage\]
          Enabled = true
          Location = \/custom\/data\/path
          RetentionPeriod = 60d
  - it: should disable local storage when specified
    set:
      server:
        storage:
          local:
            enabled: false
          # One of these must be set to true
          s3:
            enabled: true
            bucket: test
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[LocalStorage\]
          Enabled = false
    - notMatchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          Location = \/opt\/chronicle-data
          RetentionPeriod = 30d
  - it: should enable and configure S3 storage when specified
    set:
      server:
        storage:
          s3:
            enabled: true
            bucket: test
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[S3Storage\]
          Enabled = true
          Bucket = test
    - notMatchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          Prefix = .*
          Profile = .*
          Region = .*
  - it: should add extra options to S3 when specified
    set:
      server:
        storage:
          s3:
            enabled: true
            bucket: test
            prefix: test-prefix
            profile: test-profile
            region: test-region
    asserts:
    - matchRegex:
        path: data["posit-chronicle.gcfg"]
        pattern: |
          \[S3Storage\]
          Enabled = true
          Bucket = test
          Prefix = test-prefix
          Profile = test-profile
          Region = test-region
