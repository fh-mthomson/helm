suite: Workbench Deployment
templates:
  - configmap-general.yaml
  - configmap-prestart.yaml
  - configmap-secret.yaml
  - configmap-session.yaml
  - deployment.yaml
tests:
  - it: should not specify the RollingUpdate configuration if the strategy type is not RollingUpdate
    template: deployment.yaml
    set:
      strategy:
        type: "Recreate"
    asserts:
      - notExists:
          path: "spec.strategy.rollingUpdate"
  - it: should specify the RollingUpdate configuration if the strategy type is RollingUpdate
    template: deployment.yaml
    set:
      strategy:
        type: "RollingUpdate"
        rollingUpdate:
          maxUnavailable: 1
          maxSurge: "50%"
    asserts:
      - equal:
          path: "spec.strategy.type"
          value: "RollingUpdate"
      - equal:
          path: "spec.strategy.rollingUpdate.maxUnavailable"
          value: 1
      - equal:
          path: "spec.strategy.rollingUpdate.maxSurge"
          value: "50%"
  - it: should specify the diagnostic env vars if diagnostics is enabled
    template: deployment.yaml
    set:
      diagnostics:
        enabled: true
        directory: "/var/log/rstudio-workbench"
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="DIAGNOSTIC_DIR")].value'
          value: "/var/log/rstudio-workbench"
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="DIAGNOSTIC_ENABLE")].value'
          value: "true"
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="DIAGNOSTIC_ONLY")].value'
          value: "true"
  - it: should not specify the diagnostic env vars if diagnostics is not enabled
    template: deployment.yaml
    set:
      diagnostics:
        enabled: false
        directory: "/var/log/rstudio-workbench"
    asserts:
      - notExists:
          path: 'spec.template.spec.containers[0].env[?(@.name=="DIAGNOSTIC_DIR")]'
      - notExists:
          path: 'spec.template.spec.containers[0].env[?(@.name=="DIAGNOSTIC_ENABLE")]'
      - notExists:
          path: 'spec.template.spec.containers[0].env[?(@.name=="DIAGNOSTIC_ONLY")]'
  - it: should set the RSTUDIO_LAUNCHER_STARTUP_HEALTHCHECK_ARGS env var if launcher.kubernetesHealthCheck.enabled is true
    template: deployment.yaml
    set:
      launcher:
        kubernetesHealthCheck:
          enabled: true
          extraCurlArgs: ["-fsSL", "-k"]
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSTUDIO_LAUNCHER_STARTUP_HEALTH_CHECK_ARGS")].value'
          value: "-fsSL -k"
      - notExists:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSTUDIO_LAUNCHER_STARTUP_HEALTH_CHECK")]'
  - it: should set the RSTUDIO_LAUNCHER_STARTUP_HEALTH_CHECK to disabled if launcher.kubernetesHealthCheck.enabled is false
    template: deployment.yaml
    set:
      launcher:
        kubernetesHealthCheck:
          enabled: false
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSTUDIO_LAUNCHER_STARTUP_HEALTH_CHECK")].value'
          value: "disabled"
  - it: should set the ENV vars for user creation if userCreate is true
    template: deployment.yaml
    set:
      userCreate: true
      userName: "testuser"
      userPassword: "testpassword"
      userUid: 1000
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_TESTUSER")].value'
          value: "testuser"
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_TESTUSER_PASSWD")].value'
          value: "testpassword"
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_TESTUSER_UID")].value'
          value: "1000"
  - it: should set the RSW_TESTUSER ENV var to an empty string if userCreate is false
    template: deployment.yaml
    set:
      userCreate: false
      userName: "testuser"
      userPassword: "testpassword"
      userUid: 1000
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_TESTUSER")].value'
          value: ""
      - notExists:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_TESTUSER_PASSWD")]'
      - notExists:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_TESTUSER_UID")]'
  - it: should set the RSW_LOAD_BALANCING env var to true if replicas > 1
    template: deployment.yaml
    set:
      replicas: 2
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_LOAD_BALANCING")].value'
          value: "true"
  - it: should not set the RSW_LOAD_BALANCING env var replicas = 1
    template: deployment.yaml
    set:
      replicas: 1
    asserts:
      - notExists:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_LOAD_BALANCING")]'
  - it: should set the RSW_LOAD_BALANCING env var to true if loadBalancer.forceEnabled is true even if replicas = 1
    template: deployment.yaml
    set:
      replicas: 1
      loadBalancer:
        forceEnabled: true
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_LOAD_BALANCING")].value'
          value: "true"
  - it: should specify a volumeMount and a volume for sharedStorage if sharedStorage.create is true
    template: deployment.yaml
    set:
      sharedStorage:
        create: true
        path: "/mnt/shared"
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-shared-storage")].mountPath'
          value: "/mnt/shared"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-shared-storage")].persistentVolumeClaim.claimName'
          value: "RELEASE-NAME-rstudio-workbench-shared-storage"
  - it: should specify a volumeMount and a volume for sharedStorage if sharedStorage.mount is true
    template: deployment.yaml
    set:
      sharedStorage:
        mount: true
        path: "/mnt/shared"
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-shared-storage")].mountPath'
          value: "/mnt/shared"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-shared-storage")].persistentVolumeClaim.claimName'
          value: "RELEASE-NAME-rstudio-workbench-shared-storage"
